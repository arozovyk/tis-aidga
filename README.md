# TIS-AIDGA

AI-powered driver generation for TrustInSoft Analyzer.

## Overview

TIS-AIDGA is a CLI tool that uses LLMs to automatically generate verification drivers for C functions. It integrates with TrustInSoft Analyzer to validate the generated drivers through a refinement loop.

## Requirements

- Python 3.10+
- Access to a remote machine with TrustInSoft Analyzer installed (SSH)
- OpenAI API key

## Installation

### 1. Clone the repository

```bash
git clone <repository-url>
cd tis-aidga
```

### 2. Create a virtual environment (recommended)

```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

### 3. Install the package

```bash
pip install -e .
```

For development (includes pytest):

```bash
pip install -e ".[dev]"
```

### 4. Configure environment variables

Create a `.env` file in the project root:

```bash
cat > .env << EOF
# Required
SSH_PASSWORD=your_ssh_password
OPENAI_API_KEY=sk-your-openai-api-key

# Optional defaults (can also be set per-project or via CLI)
SSH_HOST=192.168.1.100
SSH_USER=username
EOF
```

**Security note:** Never commit the `.env` file. Add it to `.gitignore`.

### 5. Verify installation

```bash
tisaidga --help
```

### 6. Enable shell completion (optional)

The CLI supports tab completion for bash, zsh, and fish.

**Bash (add to `~/.bashrc`):**

```bash
eval "$(register-python-argcomplete tisaidga)"
```

**Zsh (add to `~/.zshrc`):**

```bash
autoload -U bashcompinit
bashcompinit
eval "$(register-python-argcomplete tisaidga)"
```

**Fish:**

```bash
register-python-argcomplete --shell fish tisaidga | source
```

**Global activation (all argcomplete-enabled scripts):**

```bash
activate-global-python-argcomplete
```

After adding the line, restart your shell or run `source ~/.bashrc` (or `~/.zshrc`).

Completion features:
- Project names: `tisaidga list <TAB>`, `tisaidga gen <TAB>`
- Filenames within project: `tisaidga gen myproject <TAB>`
- Model names: `tisaidga gen proj file func --model <TAB>`

## Usage

### Initialize a project

First, obtain a `compile_commands.json` from your C project (generated by CMake, Bear, or similar tools).

```bash
# Basic initialization
tisaidga init compile_commands.json

# With SSH settings stored in project config
tisaidga init compile_commands.json \
  --ssh-host 192.168.1.100 \
  --ssh-user myuser \
  --tis-env-script "source /opt/tis/bin/tis-env --source && tis_choose main"

# With custom project name
tisaidga init compile_commands.json --name my-project -v
```

### List projects and files

```bash
# List all projects
tisaidga list

# List files in a project
tisaidga list my-project

# Verbose output (shows paths and includes)
tisaidga list my-project -v
```

### Generate a driver

```bash
# Basic usage
tisaidga gen <project> <filename> <function>

# Example
tisaidga gen json-c json_object.c json_object_equal

# With options
tisaidga gen json-c json_object.c json_object_equal \
  --output drivers/my_driver.c \
  --model gpt-4o \
  --max-iterations 10 \
  -v
```

### CLI Reference

```
tisaidga init <compile_commands.json> [options]
  --name, -n          Project name (default: derived from directory)
  --ssh-host          SSH host for remote TIS
  --ssh-user          SSH username
  --tis-env-script    Script to source TIS environment
  --verbose, -v       Verbose output

tisaidga list [project] [options]
  project             Project name (omit to list all)
  --verbose, -v       Verbose output

tisaidga gen <project> <filename> <function> [options]
  --output, -o        Output file path
  --model             LLM model (default: gpt-4o-mini)
  --max-iterations    Max refinement iterations (default: 5)
  --ssh-host          Override SSH host
  --ssh-user          Override SSH username
  --tis-env-script    Override TIS environment script
  --verbose, -v       Verbose output
```

## Configuration Priority

SSH and TIS settings are resolved in this order (first match wins):

1. CLI arguments (`--ssh-host`, `--ssh-user`, etc.)
2. Project configuration (stored during `init`)
3. Environment variables (`SSH_HOST`, `SSH_USER`)

## Project Structure

After initialization, project data is stored in `.tisaidga/`:

```
.tisaidga/
└── projects/
    └── my-project/
        ├── project.json       # Project config
        └── files/
            ├── main.c.json    # File metadata
            └── utils.c.json
```

## How It Works

1. **Parse** - Reads `compile_commands.json` to extract source files, include paths, and defines
2. **Plan** - Analyzes the target function and prepares generation context
3. **Generate** - Uses LLM to generate a TIS verification driver
4. **Validate** - Two-stage validation:
   - Stage 1: Local `cc` syntax check
   - Stage 2: Remote TIS Analyzer compilation
5. **Refine** - If validation fails, feeds errors back to LLM for correction
6. **Output** - Writes the final validated driver to disk

## Development

### Run tests

```bash
pytest -v
```

### Project layout

```
tis_driver_agent/
├── __init__.py
├── cli.py              # CLI entry point
├── config.py           # Configuration dataclasses
├── state.py            # LangGraph state schema
├── graph.py            # LangGraph workflow
├── cc.py               # Local C compiler validation
├── nodes/              # LangGraph nodes
│   ├── planner.py
│   ├── router.py
│   ├── generator.py
│   ├── validator.py
│   └── refiner.py
├── models/             # LLM adapters
│   └── openai_adapter.py
├── tis/                # TIS runner (local/remote)
│   ├── base.py
│   ├── local.py
│   └── remote.py
├── utils/              # Utilities
│   ├── compilation_db.py
│   ├── context_detector.py
│   └── project_manager.py
└── prompts/            # LLM prompt templates
    └── templates.py
```

## Troubleshooting

### SSH connection fails

- Verify SSH credentials in `.env` or CLI arguments
- Ensure the remote host is reachable: `ssh user@host`
- Check firewall settings

### TIS Analyzer not found

- Ensure `tis-env-script` is correctly set to source the TIS environment
- Example: `--tis-env-script "source /opt/tis/bin/tis-env --source && tis_choose main"`

### OpenAI API errors

- Verify `OPENAI_API_KEY` is set correctly
- Check API quota and billing status

### Driver generation fails repeatedly

- Try increasing `--max-iterations`
- Use a more capable model: `--model gpt-4o`
- Check if the function has complex dependencies

## License

[Add license information]
